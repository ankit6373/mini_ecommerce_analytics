!set variable_substitution=true;

-- Target context = SILVER/COMMON for the current ENV (DEV/QA/PROD)
USE DATABASE &{ENV}_SILVER;
USE SCHEMA COMMON;


CREATE OR REPLACE TABLE DIM_CHANNEL (
  CHANNEL_ID       NUMBER AUTOINCREMENT PRIMARY KEY COMMENT 'It stores surrogate key for channel',
  RAW_SOURCE       STRING COMMENT 'It stores raw traffic source from staging',
  CHANNEL_GROUP    STRING COMMENT 'It stores normalized channel group (PAID, ORGANIC, EMAIL, SOCIAL, OTHER)'
)
COMMENT = 'It stores one row per traffic/acquisition source';

-- LOAD: DISTINCT SOURCES FROM CUSTOMERS + EVENTS
INSERT INTO DIM_CHANNEL (RAW_SOURCE, CHANNEL_GROUP)
SELECT DISTINCT
  TRAFFIC_SOURCE AS RAW_SOURCE,
  CASE
    WHEN UPPER(TRAFFIC_SOURCE) IN ('ADWORDS','SEARCH') THEN 'PAID_SEARCH'
    WHEN UPPER(TRAFFIC_SOURCE) = 'DISPLAY'             THEN 'DISPLAY'
    WHEN UPPER(TRAFFIC_SOURCE) IN ('FACEBOOK','YOUTUBE') THEN 'SOCIAL'
    WHEN UPPER(TRAFFIC_SOURCE) = 'EMAIL'               THEN 'EMAIL'
    WHEN UPPER(TRAFFIC_SOURCE) = 'ORGANIC'             THEN 'ORGANIC'
    ELSE 'OTHER'
  END AS CHANNEL_GROUP
FROM (
    SELECT TRAFFIC_SOURCE FROM &{ENV}_SILVER.STAGING.CUSTOMERS
    UNION
    SELECT TRAFFIC_SOURCE FROM &{ENV}_SILVER.STAGING.EVENTS
) T
WHERE TRAFFIC_SOURCE IS NOT NULL;
