name: Provision Deploy

on:
  push:
    branches: [ qa, main ]
    paths:
      - 'provision/**'
      - 'sql_files/**'
      - 'snowsql/**'
      - 'toolkit.conf'
      - '.github/workflows/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install actionlint
        run: |
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash -o /tmp/download-actionlint.bash
          bash /tmp/download-actionlint.bash latest /usr/local/bin
      - name: Run actionlint
        run: actionlint -color

  deploy:
    runs-on: ubuntu-latest
    needs: lint
    env:
      # Target env from pushed branch
      ENV: ${{ github.ref_name == 'qa' && 'QA' || 'PROD' }}

      # Shared inputs
      SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

      # Per-env creds
      SNOWFLAKE_USER:      ${{ github.ref_name == 'qa' && secrets.SNOWFLAKE_USER_QA   || secrets.SNOWFLAKE_USER_PROD }}
      SNOWFLAKE_PASSWORD:  ${{ github.ref_name == 'qa' && secrets.SNOWFLAKE_PASSWORD_QA || secrets.SNOWFLAKE_PASSWORD_PROD }}
      SNOWFLAKE_ROLE:      ${{ github.ref_name == 'qa' && secrets.SNOWFLAKE_ROLE_QA   || secrets.SNOWFLAKE_ROLE_PROD }}
      SNOWSQL_PWD:         ${{ github.ref_name == 'qa' && secrets.SNOWFLAKE_PASSWORD_QA || secrets.SNOWFLAKE_PASSWORD_PROD }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17 (Toolkit requires Java)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install phData Toolkit CLI
        env:
          TOOLKIT_VERSION: "0.79.0"
          TOOLKIT_URL: "https://repo.phdata.io/3BCJzuXgtfTCoa6c/toolkit-cli/maven/io/phdata/toolkit/toolkit-cli/0.79.0/toolkit-cli-0.79.0.zip"
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.phdata"
          echo "Downloading Toolkit: $TOOLKIT_URL"
          curl -sSfL "$TOOLKIT_URL" -o "/tmp/toolkit-${TOOLKIT_VERSION}.zip"
          unzip -q "/tmp/toolkit-${TOOLKIT_VERSION}.zip" -d "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}"

          if [ -x "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}/bin/toolkit" ]; then
            echo "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}/bin" >> "$GITHUB_PATH"
          elif compgen -G "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}/toolkit-cli-${TOOLKIT_VERSION}-"*.jar > /dev/null; then
            LAUNCHER="$HOME/.phdata/toolkit-${TOOLKIT_VERSION}/toolkit"
            printf "%s\n" "#!/usr/bin/env bash" \
              "exec java -jar \"\$(dirname \"\$0\")\"/toolkit-cli-*.jar \"\$@\"" > "$LAUNCHER"
            chmod +x "$LAUNCHER"
            echo "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}" >> "$GITHUB_PATH"
          else
            echo "❌ Could not find toolkit binary or jar in extracted archive:"
            find "$HOME/.phdata/toolkit-${TOOLKIT_VERSION}" -type f
            exit 1
          fi

          echo "Toolkit version:"
          toolkit --version || true

      - name: Authenticate Toolkit
        env:
          TOOLKIT_TOKEN: ${{ secrets.TOOLKIT_TOKEN }}
        run: |
          toolkit auth set-token "$TOOLKIT_TOKEN"

      - name: Apply Provision (creates/updates QA_* or PROD_*)
        run: toolkit provision apply --approve

      - name: Install SnowSQL
        run: |
          python3 -m pip install --user snowsql
          echo "$HOME/.local/bin" >> $GITHUB_PATH"

      - name: Run changed SQL
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA=${{ github.event.before }}
          HEAD_SHA=${{ github.sha }}
          bash snowsql/sql_run.sh --changed "$BASE_SHA..$HEAD_SHA"


